# Vite Plugin - Tailwind Theme Resolver

Auto-generates TypeScript types and runtime theme objects from your Tailwind CSS v4 theme files. Types regenerate automatically on file changes with HMR support.

## Installation

```bash
npm install -D tailwind-resolver
# or
bun add -D tailwind-resolver
```

## Setup

Add the plugin to your `vite.config.ts`:

```typescript
import { tailwindResolver } from 'tailwind-resolver/vite';
import { defineConfig } from 'vite';

export default defineConfig({
  plugins: [
    tailwindResolver({
      input: 'src/styles.css',
    }),
  ],
});
```

**Version-specific import** (lock to v4):

```typescript
import { tailwindResolver } from 'tailwind-resolver/v4/vite';
```

## Generated Files

The plugin generates files in your specified `outputDir`.

**Default output directory:**

- `src/generated/tailwindcss/` if your project has a `src/` folder
- `generated/tailwindcss/` otherwise

**Generated files:**

- `types.ts` - TypeScript type declarations (always)
- `theme.ts` - Runtime theme objects (if `generateRuntime` enabled)
- `index.ts` - Re-exports (if `generateRuntime` enabled)
- `conflicts.md` - Human-readable conflict report (if CSS conflicts detected and reports enabled)
- `conflicts.json` - Machine-readable conflict report (if CSS conflicts detected and reports enabled)
- `unresolved.md` - Human-readable unresolved variable report (if unresolved variables detected and reports enabled)
- `unresolved.json` - Machine-readable unresolved variable report (if unresolved variables detected and reports enabled)

### `types.ts` (Always Generated)

TypeScript type declarations for your theme:

```typescript
/**
 * ⚠️ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 */

export interface GeneratedTheme {
  colors: {
    primary: { 500: 'oklch(0.65 0.20 250)' };
    background: '#ffffff';
  };
  fontSize: {
    xl: { size: '1.25rem'; lineHeight: '1.75rem' };
  };
  // ... all other namespaces
}

// Augments the runtime API types
declare module 'tailwind-resolver' {
  interface Theme extends GeneratedTheme {}
}

// Export declarations for runtime objects (if generateRuntime: true)
export declare const base: GeneratedTheme;
export declare const dark: Partial<GeneratedTheme>;
export declare const selectors: { dark: string };
```

### `themes.ts` (Generated by Default)

Runtime theme objects for immediate use (opt-out with `generateRuntime: false`):

```typescript
/**
 * ⚠️ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 */

export const base = {
  colors: {
    primary: { 500: 'oklch(0.65 0.20 250)' },
    background: '#ffffff',
  },
  fontSize: {
    xl: { size: '1.25rem', lineHeight: '1.75rem' },
  },
  // ... complete base theme
} as const;

export const dark = {
  colors: { background: '#1f2937' },
  // ... only overridden values for dark variant
} as const;

export const selectors = {
  dark: "[data-theme='dark']",
} as const;

export default base;
```

## Report Generation

The plugin generates diagnostic reports to help you identify and resolve issues in your theme configuration. Reports are enabled by default but can be controlled via the `generateRuntime.reports` option.

### Controlling Report Generation

**Disable all reports:**

```typescript
tailwindResolver({
  input: 'src/styles.css',
  generateRuntime: {
    reports: false, // Disable all diagnostic reports
  },
});
```

**Granular control:**

```typescript
tailwindResolver({
  input: 'src/styles.css',
  generateRuntime: {
    reports: {
      conflicts: true, // Enable conflict reports
      unresolved: false, // Disable unresolved variable reports
    },
  },
});
```

**Enable all reports (default behavior):**

```typescript
tailwindResolver({
  input: 'src/styles.css',
  generateRuntime: {
    reports: true, // or omit this option entirely
  },
});
```

## CSS Conflict Detection

The plugin automatically detects when CSS rules override CSS variables to ensure your runtime theme object matches actual rendered styles. This feature generates reports by default unless disabled via the `generateRuntime.reports` option.

### The Problem

Real-world CSS files often contain both CSS variables AND direct CSS rules:

```css
.theme-mono {
  --radius-lg: 0.45em; /* CSS variable */

  .rounded-lg {
    border-radius: 0; /* CSS rule - overrides the variable! */
  }
}
```

Without detection, your runtime theme would show `radius.lg: "0.45em"` when the browser renders `"0"`.

### Automatic Resolution

The plugin:

1. Detects conflicts between CSS rules and variables
2. Automatically applies high-confidence overrides to the theme
3. Generates `conflicts.md` with full details and recommendations

### Example Output

```
  ℹ  Tailwind theme updated from styles.css
⚠  3 CSS conflicts detected (see src/generated/tailwindcss/conflicts.md)
```

**`conflicts.md`** includes:

- Summary of auto-resolved vs manual-review conflicts
- Detailed information about each conflict
- Suggested actions for complex cases
- Recommendations based on conflict patterns

**High-confidence overrides** (auto-applied):

- Static values without pseudo-classes
- Simple selectors
- No media query nesting

**Manual review** (reported only):

- Dynamic values (`calc()`, `var()`)
- Pseudo-classes (`:hover`, `:focus`)
- Complex selectors or media queries

This ensures your Chart.js charts, Canvas rendering, and other runtime theme usage always use the correct values.

## Plugin Options

```typescript
interface VitePluginOptions {
  /**
   * Path to your CSS input file (relative to Vite project root)
   * @required
   */
  input: string;

  /**
   * Output directory for generated files (relative to Vite project root)
   * Auto-detects: 'src/generated/tailwindcss' if src/ exists, otherwise 'generated/tailwindcss'
   */
  outputDir?: string;

  /**
   * Resolve @import statements recursively
   * @default true
   */
  resolveImports?: boolean;

  /**
   * Control what gets generated in the runtime file
   * - false: No runtime file (types only)
   * - true: Generate all runtime data (variants, selectors, excluding debug data)
   * - object: Granular control over what to include
   * @default true
   */
  generateRuntime?:
    | boolean
    | {
        variants?: boolean; // Theme variants (default: true)
        selectors?: boolean; // CSS selectors (default: true)
        files?: boolean; // Processed files (default: false)
        variables?: boolean; // Raw variables (default: false)
        reports?:
          | boolean // Enable/disable all reports (default: true)
          | {
              conflicts?: boolean; // CSS conflict reports (default: true)
              unresolved?: boolean; // Unresolved variable reports (default: true)
            };
      };

  /**
   * Include Tailwind CSS defaults from node_modules
   * @default true
   */
  includeTailwindDefaults?: boolean;

  /**
   * Enable debug logging for troubleshooting
   * @default false
   */
  debug?: boolean;

  /**
   * Theme value overrides
   * Apply custom overrides to theme values for specific variants or globally
   * @default undefined
   *
   * @example
   * overrides: {
   *   'dark': { 'colors.background': '#000000' },
   *   '*': { 'fonts.sans': 'Inter, sans-serif' }
   * }
   */
  overrides?: OverrideOptions;
}
```

## Theme Overrides

Apply custom theme value overrides programmatically to fix unresolved variables or conflicts without modifying CSS files.

### When to Use Overrides

- **Inject external variables**: Provide values for variables from Next.js, plugins, or external sources
- **Fix variant-specific values**: Override theme properties for dark mode or custom themes
- **Global customization**: Apply consistent values across all variants
- **Quick prototyping**: Test theme changes without editing CSS

### Configuration

```typescript
tailwindResolver({
  input: 'src/styles.css',
  overrides: {
    default: {
      'fonts.sans': 'Inter, sans-serif',
      'radius.lg': '0.5rem',
    },
    dark: {
      'colors.background': '#000000',
    },
    '*': {
      'fonts.mono': 'JetBrains Mono, monospace',
    },
  },
});
```

### Syntax Options

**Flat notation (dot-separated paths):**

```typescript
overrides: {
  'default': {
    'colors.primary.500': '#3b82f6',
    'radius.lg': '0.5rem'
  }
}
```

**Nested notation:**

```typescript
overrides: {
  'default': {
    colors: {
      primary: {
        500: '#3b82f6'
      }
    },
    radius: {
      lg: '0.5rem'
    }
  }
}
```

**Mix both styles:**

```typescript
overrides: {
  'default': {
    'colors.primary': {
      500: '#3b82f6',
      600: '#2563eb'
    }
  }
}
```

### Selector Matching

**Variant names (use camelCase for multi-word variants):**

```typescript
overrides: {
  'dark': { 'colors.background': '#000000' },
  'themeInter': { 'fonts.sans': 'Inter, sans-serif' }  // .theme-inter → themeInter
}
```

**CSS selectors (verbose, but works):**

```typescript
overrides: {
  '[data-theme="dark"]': { 'colors.background': '#000000' }
}
```

**Special keys:**

```typescript
overrides: {
  'default': { 'colors.primary': '#3b82f6' },  // Base theme
  'base': { 'colors.primary': '#3b82f6' },     // Same as 'default'
  '*': { 'fonts.mono': 'JetBrains Mono' }      // All variants
}
```

**Important:** Variant names are automatically converted from kebab-case to camelCase:

- CSS: `.theme-inter` → Override key: `'themeInter'`
- CSS: `.theme-noto-sans` → Override key: `'themeNotoSans'`
- CSS: `.dark` → Override key: `'dark'` (no conversion needed)

Use the exact camelCase variant names from your generated types for reliable matching.

### Detailed Control

For advanced control, use object notation with flags:

```typescript
overrides: {
  'default': {
    'colors.primary': {
      value: 'var(--external-primary)',
      resolveVars: false  // Skip var() resolution for this value
    }
  }
}
```

### Common Use Cases

**1. Injecting External Variables**

Fix unresolved variables from Next.js or external sources:

```typescript
tailwindResolver({
  input: 'src/styles.css',
  overrides: {
    default: {
      'colors.primary': 'var(--next-primary)',
      'fonts.sans': 'var(--system-font)',
    },
  },
});
```

**2. Variant-Specific Overrides**

Apply overrides to dark mode or custom themes:

```typescript
tailwindResolver({
  input: 'src/styles.css',
  overrides: {
    dark: {
      'colors.background': '#000000',
      'colors.foreground': '#ffffff',
    },
    compact: {
      'spacing.lg': '0.75rem',
    },
  },
});
```

**3. Global Overrides**

Apply the same value to all variants using `'*'`:

```typescript
tailwindResolver({
  input: 'src/styles.css',
  overrides: {
    '*': {
      'fonts.sans': 'Inter, sans-serif',
      'fonts.mono': 'JetBrains Mono, monospace',
    },
  },
});
```

**4. Quick Prototyping**

Test theme changes without editing CSS:

```typescript
tailwindResolver({
  input: 'src/styles.css',
  overrides: {
    default: {
      'colors.primary.500': '#ff6b35',
      'radius.lg': '1rem',
    },
  },
});
```

### How It Works

The override system uses a two-phase approach:

1. **Pre-resolution**: Synthetic CSS variables are injected before the resolution pipeline
2. **Post-resolution**: Direct mutations are applied to the resolved theme object

This ensures that both `var()` references and final theme values are correctly overridden.

### Debug Mode

Enable debug logging to see what overrides are being applied:

```typescript
tailwindResolver({
  input: 'src/styles.css',
  debug: true,
  overrides: {
    dark: { 'colors.background': '#000000' },
  },
});
```

**Console output:**

```
[Override] Injected --color-background: #000000 (variant: dark, pre-resolution)
[Override] Applied colors.background = #000000 (variant: dark, post-resolution)
```

## Usage Examples

### Chart.js Integration

```typescript
import { Chart } from 'chart.js';

import { base } from './generated/tailwindcss/themes';

new Chart(ctx, {
  type: 'bar',
  data: {
    datasets: [
      {
        backgroundColor: [
          base.colors.primary[500],
          base.colors.secondary[500],
          base.colors.tertiary[500],
        ],
      },
    ],
  },
});
```

### Dynamic Theme Switching

```typescript
import { base, dark, selectors } from './generated/tailwindcss/themes';

function applyTheme(mode: 'light' | 'dark') {
  const theme = mode === 'light' ? base : dark;

  // Apply CSS selector
  document.documentElement.setAttribute('data-theme', mode);

  // Update chart colors
  chartInstance.data.datasets[0].backgroundColor = theme.colors.primary[500];
  chartInstance.update();
}
```

### Canvas Rendering

```typescript
import { base } from './generated/tailwindcss/themes';

function drawText(ctx: CanvasRenderingContext2D) {
  ctx.fillStyle = base.colors.foreground;
  ctx.font = `${base.fontSize.xl.size} ${base.fonts.display}`;
  ctx.fillText('Hello World', 10, 50);
}
```

### React Component

```typescript
import { base, dark } from './generated/tailwindcss/themes';

function ThemedComponent() {
  const [mode, setMode] = useState<'light' | 'dark'>('light');
  const theme = mode === 'light' ? base : dark;

  return (
    <div style={{ backgroundColor: theme.colors.background }}>
      <canvas ref={(el) => el && drawChart(el, theme)} />
    </div>
  );
}
```

## Features

### Automatic Regeneration

The plugin watches your CSS files and regenerates types on every change:

```css
/* src/styles.css */
@theme {
  --color-brand: #3b82f6;
}
```

**Save the file** → Types regenerate automatically → Autocomplete updates immediately

### Multi-File Support

Automatically tracks all imported CSS files:

```css
/* src/styles.css */
@import './colors.css';
@import './typography.css';

@theme {
  /* Additional variables */
}
```

Changes to any imported file trigger regeneration.

### Theme Variants

Resolves dark mode and custom theme variants:

```css
@theme {
  --color-background: #ffffff;
}

[data-theme='dark'] {
  --color-background: #1f2937;
}

.midnight {
  --color-background: #0f172a;
}
```

**Generated exports:**

```typescript
export const base = { colors: { background: '#ffffff' } };
export const dark = { colors: { background: '#1f2937' } };
export const midnight = { colors: { background: '#0f172a' } };

export const selectors = {
  dark: "[data-theme='dark']",
  midnight: '.midnight',
};
```

## TypeScript Configuration

Ensure generated files are included in `tsconfig.json`:

```json
{
  "include": ["src/**/*"],
  "compilerOptions": {
    "skipLibCheck": true
  }
}
```

## Git Configuration

You can choose to commit or ignore the generated files:

```gitignore
# Option 1: Ignore generated files (regenerates on each machine)
src/generated/

# Option 2: Commit generated files (available immediately after clone)
# (Recommended for teams - similar to Prisma Client)
```

## Troubleshooting

### Types Not Updating

1. Save the CSS file to trigger regeneration
2. Verify `input` points to the correct file
3. Check Vite console for error messages
4. Restart TypeScript server (VS Code: `Cmd+Shift+P` → "Restart TS Server")

### Import Errors

```
Cannot find module './generated/tailwindcss/themes'
```

**Solutions:**

1. Runtime generation is enabled by default - check the plugin logs
2. Start the dev server at least once to generate files
3. Check that `outputDir` exists in your `tsconfig.json` include paths
4. Verify the generated files exist in the file system
5. Set `generateRuntime: false` if you only need type declarations

### HMR Not Working

The plugin logs theme updates to the console:

```
  ℹ  Tailwind theme updated from styles.css
```

If you don't see this message:

1. Verify the CSS file is being watched by Vite
2. Check that the file is inside your project root
3. Ensure `resolveImports: true` if using `@import` statements

## Performance

- Type regeneration: ~5-10ms for typical themes
- No impact on HMR performance
- Efficient file watching via Vite's native watcher
- Incremental updates (only regenerates on CSS changes)

## Comparison: Runtime vs. Build-Time Resolution

### Without Plugin (Runtime Resolution)

```typescript
// Async call on every app load
const { theme } = await resolveTheme({ filePath: './styles.css' });
const color = theme.colors.primary; // Generic types
```

### With Plugin (Build-Time Generation)

```typescript
// Sync import, generated at build time

import { base } from './generated/tailwindcss/themes';

const color = base.colors.primary[500]; // Exact literal type
```

## Best Practices

1. **Enable `generateRuntime: true`** for production builds to avoid async calls
2. **Commit generated files** for team projects (like Prisma Client)
3. **Use exact output directory** in your `tsconfig.json` includes
4. **Organize theme CSS** by namespace for easier maintenance

## Advanced Configuration

### Disable Import Resolution

```typescript
tailwindResolver({
  input: 'src/styles.css',
  resolveImports: false, // Don't process @import statements
});
```

### Disable Tailwind Defaults

```typescript
tailwindResolver({
  input: 'src/styles.css',
  includeTailwindDefaults: false, // Don't include Tailwind CSS defaults
});
```

### Granular Runtime Control

```typescript
// Production build: minimal bundle size
tailwindResolver({
  input: 'src/styles.css',
  generateRuntime: {
    variants: true, // Need theme data
    selectors: true, // Need selectors for dynamic switching
    files: false, // Skip debug data
    variables: false, // Skip debug data
  },
});

// Development: include everything for debugging
tailwindResolver({
  input: 'src/styles.css',
  generateRuntime: true, // All fields included
});

// Types only (no runtime bundle)
tailwindResolver({
  input: 'src/styles.css',
  generateRuntime: false, // Only generate types.ts
});
```

## Examples

See the [main README](../../../README.md) for more detailed examples and API documentation.

## Requirements

- Vite >= 5.0
- TypeScript >= 5.0
- Node.js >= 18 or Bun >= 1.0
